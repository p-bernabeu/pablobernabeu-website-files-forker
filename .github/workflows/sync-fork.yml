name: Sync Fork from Private Repository

on:
  schedule: 
    # Runs daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:    # Allows manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository:  pablobernabeu/website-files
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          fetch-depth:  0
          path: source-repo
          
      - name:  Checkout destination repository
        uses:  actions/checkout@v4
        with:
          repository: p-bernabeu/pablobernabeu-website-files-forker
          token: ${{ secrets.PRIVATE_REPO_PAT }}
          fetch-depth: 0
          path: dest-repo
          ref: main
          
      - name: Sync content (preserve workflows)
        run: |
          # Save the workflow file
          cp dest-repo/.github/workflows/sync-fork.yml /tmp/sync-fork.yml
          
          # Remove all content from dest-repo except .git
          cd dest-repo
          find . -mindepth 1 -maxdepth 1 !  -name '.git' -exec rm -rf {} +
          
          # Copy all content from source-repo
          cd ../source-repo
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec cp -r {} ../dest-repo/ \;
          
          # Restore the workflow file
          mkdir -p ../dest-repo/.github/workflows
          cp /tmp/sync-fork.yml ../dest-repo/.github/workflows/sync-fork.yml
          
          # Commit and push changes
          cd ../dest-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Sync from pablobernabeu/website-files" || echo "No changes to commit"
          git push origin main
